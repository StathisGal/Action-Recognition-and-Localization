import torch
from torch.autograd import Function
# from _ext import calc as c
from ._ext import calc as c

import sys
import numpy

class Translate_Calculator(Function):

    def __init__(self, sample_duration, step ):

        self.sample_duration = sample_duration
        self.step = step

    def forward(self, N, K, n_frames, p_tubes, final_combinations):

        N = N.int().item()
        K = K.int().item()
        n_frames = n_frames.int().item()
        n_combs = final_combinations.size(0)
        ret_tubes = p_tubes.new(n_combs,n_frames,4).zero_()

        c.calc_test_cuda(K, N, n_frames,n_combs, self.sample_duration, self.step, p_tubes.view(-1).contiguous(),\
                         final_combinations.view(-1).contiguous(), ret_tubes.view(-1))

        return ret_tubes

    def update_scores(self, final_scores, final_poss, f_scores, pos, pos_indices, actioness, \
                      overlaps_scr):

        # print('Updating thresh')  
        ## first update next loop

        _, indices = torch.sort(f_scores,descending=True)

        # if self.thresh == f_scores[indices[self.k]].item():

        #     print('f_scores[:self.k] :',f_scores[:self.k].cpu().numpy())
        #     self.thresh = self.thresh + 0.001
        # else:
        #     self.thresh = f_scores[indices[self.k]].item()

        indices = indices[:self.k]
        # self.thresh = f_scores[self.update_thresh].item()
        # self.thresh = f_scores[self.k].item()

        pos = pos[indices].contiguous()
        pos_indices = pos_indices[indices].contiguous()
        actioness = actioness[indices].contiguous()
        overlaps_scr = overlaps_scr[indices].contiguous()
        f_scores = f_scores[indices].contiguous()

        ## now time for final scores
        indices = final_scores.ge(self.thresh).nonzero()

        indices = indices.squeeze()
        # print('final_scores.shape :',final_scores.shape)
        # print('final_poss.shape :',final_poss.shape)
        final_scores = final_scores[indices].contiguous()
        final_poss = final_poss[indices].contiguous()

        return final_scores, final_poss, pos, pos_indices, \
            actioness, overlaps_scr,  f_scores
        
if __name__ == '__main__':

    p_tubes = torch.Tensor([[[ 24.0000,  26.0000,  80.0000,  98.0000,  24.0000,  26.0000,  80.0000, 98.0000,  22.0000,  25.0000,  79.0000,  98.0000,  22.0000,  25.0000,
           79.0000,  98.0000,  22.0000,  25.0000,  79.0000,  98.0000,  21.0000,           25.0000,  77.0000,  98.0000,  21.0000,  25.0000,  77.0000,  98.0000,
           19.0000,  25.0000,  76.0000,  98.0000],         [ 36.3064,  58.0873,  77.0560, 111.0000,  34.4883,  55.8166,  75.9375,
          111.0000,  34.8701,  56.6109,  75.1996, 111.0000,  35.6296,  59.2946,           76.9107, 111.0000,  33.6842,  54.9033,  74.8464, 111.0000,  34.8520,
           60.4129,  75.1001, 111.0000,  35.9312,  56.7224,  75.9545, 111.0000,           35.3712,  58.6752,  76.0704, 111.0000],
         [ 33.5993,  18.7219,  52.8658,  69.9301,  33.3072,  18.4711,  53.0668,           71.5176,  34.4660,  17.7977,  53.4924,  71.7434,  33.2821,  19.0323,
           52.9729,  71.2363,  33.5238,  19.2454,  52.7240,  70.3568,  33.3001,           17.7844,  52.1310,  69.9691,  33.4625,  19.2425,  52.5406,  70.8781,
           32.9757,  19.8320,  52.5223,  69.6938],         [ 11.6171,  53.0635,  75.7720, 111.0000,  13.6416,  53.9236,  74.0098,
          111.0000,   9.0354,  55.9858,  75.7031, 111.0000,   7.2326,  52.4596,           69.6434, 111.0000,  11.5405,  56.9170,  73.3444, 111.0000,  12.3752,
           53.5591,  74.8658, 111.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,   0.0000,   0.0000],
         [ 41.8777,  21.1912,  62.1475,  63.7057,  42.3008,  21.1440,  62.5663,           63.5965,  42.5883,  20.6702,  63.2295,  62.7200,  40.6816,  20.1711,
           61.9464,  62.8636,  40.8899,  20.6798,  61.9030,  62.1662,  41.6476,           20.1834,  63.0137,  62.8117,  41.1888,  19.6194,  62.9872,  61.9815,
           40.8055,  20.4045,  62.3763,  62.9462],         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,  35.3729,  76.7238,  79.3041, 100.7943,  35.8116,  76.4705,           79.5732, 100.3682,  31.4699,  76.3569,  77.7262, 100.9456,  34.2591,
           76.9358,  77.9931, 100.7869,  31.3225,  76.8024,  78.3483, 100.5253,           31.0658,  77.3855,  78.6042, 101.5414],
         [ 58.5392,  22.6995,  77.7231,  60.3058,  58.4766,  22.3160,  77.5200,           60.1417,  58.7225,  21.4949,  78.1236,  59.5145,  57.0611,  20.9362,
           77.2532,  59.4721,  56.8438,  21.0715,  76.7834,  58.0271,  57.8757,           21.2222,  77.9286,  59.5503,  57.5138,  20.7360,  77.9754,  58.4644,
           57.0112,  21.6103,  77.2305,  59.2233],         [  0.0000,   0.0000,   0.0000,   0.0000,  56.8867,  49.6703, 111.0000,
           98.9913,  66.0395,  49.9694, 111.0000,  95.9886,  56.6674,  50.3466,          111.0000,  96.1444,  61.0964,  45.4433, 111.0000,  95.6105,  57.5928,
           48.3655, 111.0000,  97.6443,  62.2252,  45.6979, 111.0000,  92.5280,            0.0000,   0.0000,   0.0000,   0.0000],
         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   8.8851,  65.6695,  95.7211, 111.0000,  18.0397,  65.9690,
          104.8593, 111.0000,   8.6671,  66.3439,  97.4503, 111.0000,  13.0948,           61.4432, 105.4802, 111.0000,   9.5901,  64.3632,  99.4728, 111.0000,
           14.2281,  61.6974, 101.0976, 108.5273],         [  0.0000,   0.0000,  88.0001, 111.0000,   0.0000,   0.0000,  88.0002,
          111.0000,   0.0000,   0.0000,  88.0004, 111.0000,   0.0000,   0.0000,           88.0001, 111.0000,   0.0000,   0.0000,  88.0011, 111.0000,   0.0000,
            0.0000,  87.9997, 111.0000,   0.0000,   0.0000,  87.9993, 111.0000,            0.0000,   0.0000,  88.0004, 111.0000],
         [ 53.5269,  45.5251,  79.8719,  94.3358,  52.5165,  46.0079,  79.6091,           93.9469,  52.2839,  45.7632,  80.5561,  92.1893,  51.9485,  44.4792,
           81.0463,  92.4423,  49.6766,  44.7019,  79.3989,  93.1393,  49.1771,           43.6021,  79.8296,  92.4349,  49.3923,  43.7779,  80.4580,  92.2828,
           48.5274,  44.9610,  81.8612,  93.9666],         [ 23.1647,  70.1558,  54.4166, 102.3567,  23.1082,  71.3100,  55.5969,
          103.0439,  26.1432,  70.5508,  57.1982, 104.1937,  25.5087,  70.1663,           57.7767, 102.7765,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,   0.0000,   0.0000],
         [  0.0000,   0.0000,   0.0000,   0.0000,  21.7428,   0.0000, 111.0000,           77.8782,  29.5840,   0.0000, 111.0000,  82.4964,  30.4487,   0.0000,
          111.0000,  82.0637,  27.4021,   0.0000, 111.0000,  93.5023,  24.8676,            0.0000, 111.0000,  86.8977,  25.6044,   0.0000, 111.0000,  91.2473,
            0.0000,   0.0000,   0.0000,   0.0000],         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   8.8861,  33.6679,  95.7253,  82.9891,  18.0385,  33.9676,          104.8594,  79.9900,   8.6683,  34.3424,  97.4500,  80.1414,  13.0987,
           29.4430, 105.4815,  79.6097,   9.5908,  32.3611,  99.4735,  81.6456,           14.2307,  29.6969, 101.1006,  76.5263],
         [  0.0000,   0.0000,   0.0000,   0.0000,  60.6019,  48.5337,  81.4613,           91.4086,  60.4651,  49.7630,  82.4625,  95.2255,  60.6407,  49.4178,
           83.6717,  90.8898,  62.3384,  47.7162,  83.8869,  91.8434,  62.0616,           46.0166,  84.0219,  92.6458,  60.7607,  51.4807,  83.6868,  95.7900,
            0.0000,   0.0000,   0.0000,   0.0000],         [ 51.8322,  56.3926,  96.8056, 111.0000,  51.7119,  59.7389,  94.6019,
          111.0000,  47.7055,  65.8172,  91.9188, 111.0000,  50.9338,  57.3955,           97.2464, 111.0000,  50.7495,  61.9671,  97.0313, 111.0000,  49.4871,
           54.3109,  94.2697, 111.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,   0.0000,   0.0000]],
        [[ 19.0000,  25.0000,  76.0000,  98.0000,  19.0000,  25.0000,  76.0000,           98.0000,  19.0000,  25.0000,  76.0000,  98.0000,  18.0000,  25.0000,
           74.0000,  98.0000,  17.0000,  25.0000,  74.0000,  98.0000,  16.0000,           24.0000,  73.0000,  98.0000,  16.0000,  24.0000,  73.0000,  98.0000,
           16.0000,  24.0000,  73.0000,  98.0000],         [ 11.3151,  50.5567,  35.2479,  95.3068,  10.5939,  50.2525,  35.1287,
           94.9865,  10.9381,  50.2860,  36.4627,  94.3269,   9.7572,  49.0911,           35.8063,  93.9241,   9.0279,  48.9275,  35.3864,  94.0852,   9.2305,
           49.5506,  35.9549,  95.3603,   9.4532,  49.6184,  35.5736,  95.2521,            9.2038,  50.5237,  36.1078,  96.5662],
         [  0.0000,   0.0000,   0.0000,   0.0000,  23.0928,  73.4067,  53.3445,          104.9577,  23.1216,  70.2179,  56.8500, 102.4850,  26.4322,  71.1794,
           56.5991, 102.2527,  25.3825,  72.5260,  57.0442, 103.9336,  26.3409,           72.5583,  56.6198, 104.1696,  25.1746,  69.2358,  58.0078, 103.1733,
            0.0000,   0.0000,   0.0000,   0.0000],         [ 37.2722,  24.4526, 101.5309,  85.5712,  39.2478,  23.2681, 103.6543,
           87.8942,  32.9609,  28.4425,  98.2433,  90.3724,  33.3882,  23.1414,           99.4257,  91.1272,  34.8892,  26.7434,  98.2807,  91.2754,  35.7417,
           27.1795, 102.0385,  89.7931,  34.8042,  24.0505,  96.9908,  86.3844,           39.8359,  25.1796, 101.3995,  91.3289],
         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   0.0000,  41.3652,   0.0000, 111.0000,  87.0414,  46.6868,            0.0000, 111.0000,  96.5819,  48.8052,   0.0000, 111.0000,  88.5643,
           44.3991,   0.0000, 111.0000,  89.0207],         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   7.0927,  73.4077,  37.3444, 104.9568,   7.1225,  70.2185,           40.8508, 102.4856,  10.4313,  71.1791,  40.5999, 102.2528,   9.3807,
           72.5264,  41.0429, 103.9331,  10.3426,  72.5584,  40.6214, 104.1694,            9.1744,  69.2359,  42.0078, 103.1735],
         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   8.3921,  32.8056,           96.7274,   0.0000,  11.7383,  30.6018, 105.4038,   0.0000,  17.8156,
           27.9198, 102.7649,   0.0000,   9.3953,  33.2459, 102.7194,   0.0000,           13.9663,  33.0322, 103.3550,   0.0000,   6.3133,  30.2691,  96.1240,
            0.0000,   0.0000,   0.0000,   0.0000],         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,  33.5727,  28.6614,  77.4680,  51.7877,  34.0127,
           27.0112,  78.8220,  52.3925,  34.0701,  28.9318,  78.5908,  52.5947,           30.3145,  29.9421,  76.3978,  52.7036],
         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,  33.6687,  47.7239,  82.9906,   0.0000,  33.9688,
           56.8607,  79.9910,   0.0000,  34.3429,  49.4532,  80.1421,   0.0000,           29.4435,  57.4820,  79.6106,   0.0000,  32.3632,  51.4720,  81.6459,
            0.0000,  29.6966,  53.0991,  76.5268],         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   0.0000,   0.0000,   0.0000,   0.0000,  23.1649,  38.1584,           54.4163,  70.3586,  23.1085,  39.3104,  55.5986,  71.0444,  26.1438,
           38.5506,  57.1985,  72.1933,  25.5092,  38.1658,  57.7779,  70.7757,            0.0000,   0.0000,   0.0000,   0.0000],
         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,   0.0000,   0.0000,   0.0000,  28.3678,  16.4284,
          111.0000,  65.3274,  25.0367,  17.2028, 111.0000,  63.2691,  23.7779,           14.1419, 111.0000,  63.1143,  30.4640,  13.3010, 111.0000,  60.7870,
            0.0000,   0.0000,   0.0000,   0.0000],         [ 32.4637,  70.6623, 107.9728, 111.0000,  35.8844,  68.0206, 105.4624,
          111.0000,  37.1514,  65.3368, 108.3163, 111.0000,  34.0455,  67.6338,          105.6201, 111.0000,  37.3029,  69.6007, 106.5755, 111.0000,  35.3099,
           66.6402, 107.2981, 111.0000,  35.3471,  66.0251, 110.1779, 111.0000,           32.2696,  65.3676, 107.4405, 111.0000],
         [  0.0000,   0.0000,  75.7058,  77.8771,   0.0000,   0.0000,  79.7438,           82.4982,   0.0000,   0.0000,  71.4777,  82.0567,   0.0000,   0.0000,
           79.8691,  93.5031,   0.0000,   0.0000,  75.0046,  86.8960,   0.0000,            0.0000,  74.2329,  91.2451,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   0.0000,   0.0000,   0.0000],         [ 32.7525,  20.8723,  52.9904,  69.9948,  32.2163,  19.6755,  53.8674,
           71.0077,  33.6072,  19.5138,  54.1318,  71.8872,  32.1571,  21.4004,           52.8822,  70.9954,  32.9125,  21.6217,  53.3327,  70.6441,  32.4001,
           20.2286,  52.3596,  69.8048,  32.3224,  21.1879,  52.3738,  71.3160,           32.0504,  21.2414,  52.7885,  68.8686],
         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   7.0927,  73.4077,  37.3444, 104.9568,   7.1225,  70.2185,
           40.8508, 102.4856,  10.4313,  71.1791,  40.5999, 102.2528,   9.3807,           72.5264,  41.0429, 103.9331,  10.3426,  72.5584,  40.6214, 104.1694,
            9.1744,  69.2359,  42.0078, 103.1735],         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,  23.1649,  70.1585,  54.4162, 102.3586,  23.1084,  71.3103,           55.5987, 103.0443,  26.1437,  70.5508,  57.1984, 104.1934,  25.5090,
           70.1659,  57.7775, 102.7762,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,   0.0000,   0.0000]],
        [[ 16.0000,  24.0000,  73.0000,  98.0000,  15.0000,  24.0000,  72.0000,           98.0000,  14.0000,  25.0000,  71.0000,  98.0000,  14.0000,  25.0000,
           71.0000,  98.0000,  14.0000,  25.0000,  71.0000,  98.0000,  14.0000,           25.0000,  66.0000,  98.0000,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   0.0000,   0.0000,   0.0000],         [  0.0000,   0.0000,   0.0000,   0.0000,  39.0926,  73.4063,  69.3442,
          104.9573,  39.1219,  70.2182,  72.8500, 102.4852,  42.4323,  71.1795,           72.5990, 102.2531,  41.3824,  72.5264,  73.0443, 103.9337,  42.3405,
           72.5583,  72.6193, 104.1691,  41.1745,  69.2358,  74.0082, 103.1736,            0.0000,   0.0000,   0.0000,   0.0000],
         [  0.0000,   0.0000,   0.0000,   0.0000,  43.6163,  37.0634, 107.7700,          100.8904,  45.6419,  37.9237, 106.0098, 100.1783,  41.0320,  39.9879,
          107.7025, 102.4763,  39.2350,  36.4596, 101.6454, 104.1576,  43.5410,           40.9155, 105.3454, 106.5768,  44.3782,  37.5599, 106.8668,  99.9699,
            0.0000,   0.0000,   0.0000,   0.0000],         [ 39.1647,  22.1561,  70.4164,  54.3565,  39.1077,  23.3103,  71.5968,
           55.0442,  42.1436,  22.5506,  73.1981,  56.1938,  41.5082,  22.1664,           73.7770,  54.7769,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,   0.0000,   0.0000],
         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,  17.6693,  47.7216,  66.9910,   0.0000,  17.9687,
           56.8607,  63.9894,   0.0000,  18.3447,  49.4527,  64.1433,   0.0000,           13.4435,  57.4819,  63.6104,   0.0000,  16.3639,  51.4737,  65.6449,
            0.0000,  13.6973,  53.0959,  60.5272],         [  2.8351,  41.1068,  40.5671,  78.4289,   4.2325,  39.9337,  41.8314,
           76.4872,   2.0413,  39.2203,  38.2713,  75.2674,   1.3491,  40.4941,           39.9757,  76.0827,   3.6930,  40.1013,  41.2286,  77.0490,   7.7893,
           40.5343,  43.7535,  78.0161,   8.4847,  42.1379,  44.2095,  79.3101,            7.5633,  41.4427,  44.2388,  80.3676],
         [ 17.1960,  56.3610,  55.8010,  92.5866,  20.6522,  54.7467,  59.2395,           89.9881,  16.6155,  53.5537,  53.3903,  88.9992,  15.3308,  55.6474,
           54.8393,  90.0672,  19.1769,  55.3153,  56.9973,  91.3763,  22.9755,           55.2520,  59.0860,  92.4348,  21.8337,  57.6770,  58.6589,  94.4160,
           22.4400,  56.1383,  60.3393,  95.4442],         [  0.0000,   0.0000,   0.0000,   0.0000,  19.8336,   8.3925,  64.8055,
           96.7252,  19.7115,  11.7378,  62.6014, 105.4047,  15.7056,  17.8152,           59.9198, 102.7649,  18.9347,   9.3969,  65.2460, 102.7206,  18.7508,
           13.9660,  65.0328, 103.3564,  17.4876,   6.3127,  62.2691,  96.1239,            0.0000,   0.0000,   0.0000,   0.0000],
         [  0.0000,  40.0001, 111.0000, 111.0000,   0.0000,  40.0001, 111.0000,          111.0000,   0.0000,  40.0002, 111.0000, 111.0000,   0.0000,  39.9996,
          111.0000, 111.0000,   0.0000,  40.0000, 111.0000, 111.0000,   0.0000,           39.9998, 111.0000, 111.0000,   0.0000,  39.9999, 111.0000, 111.0000,
            0.0000,  40.0003, 111.0000, 111.0000],         [  0.0000,   0.0000,   0.0000,   0.0000,  28.6021,  16.5331,  49.4614,
           59.4098,  28.4639,  17.7631,  50.4619,  63.2238,  28.6405,  17.4170,           51.6707,  58.8896,  30.3375,  15.7161,  51.8857,  59.8433,  30.0608,
           14.0173,  52.0219,  60.6459,  28.7604,  19.4802,  51.6867,  63.7908,            0.0000,   0.0000,   0.0000,   0.0000],
         [  0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,  33.6692,  47.7230,  82.9910,   0.0000,  33.9687,
           56.8607,  79.9898,   0.0000,  34.3443,  49.4527,  80.1429,   0.0000,           29.4437,  57.4815,  79.6106,   0.0000,  32.3638,  51.4734,  81.6450,
            0.0000,  29.6970,  53.0965,  76.5269],         [ 59.2192,  37.1726,  81.2594,  97.6723,  59.0892,  37.1178,  81.4364,
           98.2581,  59.7957,  37.6224,  81.4751,  98.8649,  59.1074,  38.2212,           80.4598,  98.4358,  59.3104,  38.2724,  80.5029,  97.9369,  59.6935,
           37.7827,  80.2957,  97.6609,  59.5201,  38.8666,  80.5465,  98.6007,           59.0738,  37.6797,  80.5907,  97.3186],
         [ 44.6019,  48.5360,  65.4609,  91.4088,  44.4666,  49.7617,  66.4643,           95.2272,  44.6434,  49.4183,  67.6742,  90.8915,  46.3387,  47.7148,
           67.8870,  91.8412,  46.0605,  46.0168,  68.0207,  92.6436,  44.7617,           51.4815,  67.6886,  95.7930,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   0.0000,   0.0000,   0.0000],         [ 42.3067,  65.9580,  63.0513, 106.9729,  42.6580,  65.6635,  63.1792,
          106.9042,  43.0284,  65.2138,  64.3631, 106.1528,  39.8411,  64.4239,           62.0619, 105.6579,  40.9198,  65.1173,  62.6194, 104.0945,  41.6296,
           65.8853,  63.8216, 106.5241,  40.4876,  65.2359,  63.4011, 105.4640,           39.5818,  66.0973,  61.8114, 106.1785],
         [  0.0000,  49.6685,  79.7118,  98.9893,   2.0331,  49.9717,  88.8557,           95.9904,   0.0000,  50.3488,  81.4489,  96.1470,   0.0000,  45.4406,
           89.4858,  95.6090,   0.0000,  48.3646,  83.4661,  97.6453,   0.0000,           45.6979,  85.0941,  92.5276,   0.0000,   0.0000,   0.0000,   0.0000,
            0.0000,   0.0000,   0.0000,   0.0000],         [ 23.0928,   9.4066,  53.3441,  40.9578,  23.1220,   6.2183,  56.8497,
           38.4852,  26.4327,   7.1788,  56.5998,  38.2525,  25.3830,   8.5263,           57.0445,  39.9337,  26.3400,   8.5581,  56.6193,  40.1685,  25.1750,
            5.2358,  58.0083,  39.1735,   0.0000,   0.0000,   0.0000,   0.0000,            0.0000,   0.0000,   0.0000,   0.0000]]]).cuda()
    print('p_tubes.shape :',p_tubes.shape)

    exp_ret =torch.Tensor([[[24., 26., 80., 98.], [24., 26., 80., 98.], [22., 25., 79., 98.], [22., 25., 79., 98.], [22., 25., 79., 98.], [21., 25., 77., 98.], [21., 25., 77., 98.],
                             [19., 25., 76., 98.], [19., 25., 76., 98.], [19., 25., 76., 98.], [19., 25., 76., 98.], [18., 25., 74., 98.], [17., 25., 74., 98.], [16., 24., 73., 98.], 
                             [16., 24., 73., 98.], [16., 24., 73., 98.], [16., 24., 73., 98.], [15., 24., 72., 98.], [14., 25., 71., 98.], [14., 25., 71., 98.], [14., 25., 71., 98.],
                             [14., 25., 66., 98.], [ 0.,  0.,  0.,  0.], [ 0.,  0.,  0.,  0.], [ 0.,  0.,  0.,  0.]],

        [[  0.0000,   0.0000,  88.0001, 111.0000], [  0.0000,   0.0000,  88.0002, 111.0000], [  0.0000,   0.0000,  88.0004, 111.0000], [  0.0000,   0.0000,  88.0001, 111.0000],
        [  0.0000,   0.0000,  88.0011, 111.0000],  [  0.0000,   0.0000,  87.9997, 111.0000], [  0.0000,   0.0000,  87.9993, 111.0000], [  0.0000,   0.0000,  88.0004, 111.0000],
        [ 19.0000,  25.0000,  76.0000,  98.0000],  [ 19.0000,  25.0000,  76.0000,  98.0000], [ 19.0000,  25.0000,  76.0000,  98.0000], [ 18.0000,  25.0000,  74.0000,  98.0000],
        [ 17.0000,  25.0000,  74.0000,  98.0000],  [ 16.0000,  24.0000,  73.0000,  98.0000], [ 16.0000,  24.0000,  73.0000,  98.0000], [ 16.0000,  24.0000,  73.0000,  98.0000],
        [ 16.0000,  24.0000,  73.0000,  98.0000],  [ 15.0000,  24.0000,  72.0000,  98.0000], [ 14.0000,  25.0000,  71.0000,  98.0000], [ 14.0000,  25.0000,  71.0000,  98.0000],
        [ 14.0000,  25.0000,  71.0000,  98.0000],  [ 14.0000,  25.0000,  66.0000,  98.0000], [  0.0000,   0.0000,   0.0000,   0.0000], [  0.0000,   0.0000,   0.0000,   0.0000],
        [  0.0000,   0.0000,   0.0000,   0.0000]],
        [[ 24.0000,  26.0000,  80.0000,  98.0000], [ 24.0000,  26.0000,  80.0000,  98.0000], [ 22.0000,  25.0000,  79.0000,  98.0000], [ 22.0000,  25.0000,  79.0000,  98.0000],
        [ 22.0000,  25.0000,  79.0000,  98.0000], [ 21.0000,  25.0000,  77.0000,  98.0000], [ 21.0000,  25.0000,  77.0000,  98.0000], [ 19.0000,  25.0000,  76.0000,  98.0000],
        [ 19.0000,  25.0000,  76.0000,  98.0000], [ 19.0000,  25.0000,  76.0000,  98.0000], [ 19.0000,  25.0000,  76.0000,  98.0000], [ 18.0000,  25.0000,  74.0000,  98.0000],
        [ 17.0000,  25.0000,  74.0000,  98.0000], [ 16.0000,  24.0000,  73.0000,  98.0000], [ 16.0000,  24.0000,  73.0000,  98.0000], [ 16.0000,  24.0000,  73.0000,  98.0000],
        [  0.0000,  40.0001, 111.0000, 111.0000], [  0.0000,  40.0001, 111.0000, 111.0000], [  0.0000,  40.0002, 111.0000, 111.0000], [  0.0000,  39.9996, 111.0000, 111.0000],
        [  0.0000,  40.0000, 111.0000, 111.0000], [  0.0000,  39.9998, 111.0000, 111.0000], [  0.0000,   0.0000,   0.0000,   0.0000], [  0.0000,   0.0000,   0.0000,   0.0000],
        [  0.0000,   0.0000,   0.0000,   0.0000]],
    [[ 24.0000, 26.0000, 80.0000, 98.0000], [ 24.0000, 26.0000, 80.0000, 98.0000], [22.0000, 25.0000, 79.0000, 98.0000], [22.0000, 25.0000, 79.0000, 98.0000], [22.0000, 25.0000, 79.0000, 98.0000],
        [21.0000, 25.0000, 77.0000, 98.0000], [21.0000, 25.0000, 77.0000, 98.0000], [19.0000, 25.0000, 76.0000, 98.0000], [19.0000, 25.0000, 76.0000, 98.0000], [19.0000, 25.0000, 76.0000, 98.0000],
        [19.0000, 25.0000, 76.0000, 98.0000], [18.0000, 25.0000, 74.0000, 98.0000], [17.0000, 25.0000, 74.0000, 98.0000], [16.0000, 24.0000, 73.0000, 98.0000], [16.0000, 24.0000, 73.0000, 98.0000],
        [16.0000, 24.0000, 73.0000, 98.0000], [ 0.0000, 49.6685, 79.7118, 98.9893], [ 2.0331, 49.9717, 88.8557, 95.9904], [ 0.0000, 50.3488, 81.4489, 96.1470], [ 0.0000, 45.4406, 89.4858, 95.6090],
        [ 0.0000, 48.3646, 83.4661, 97.6453], [ 0.0000, 45.6979, 85.0941, 92.5276], [ 0.0000,  0.0000,  0.0000,  0.0000], [ 0.0000,  0.0000,  0.0000,  0.0000], [ 0.0000,  0.0000,  0.0000,  0.0000]]])

    final_combinations=torch.Tensor([[[0., 0.],[1., 0.],[2., 0.]],[[0., 9.], [1., 0.],[2., 0.]],[[0., 0.], [1., 0.],[2., 8.]],[[ 0.,  0.], [ 1.,  0.], [ 2, 14.]]])

    sample_duration = 8
    N = torch.Tensor([3]) # number of clips
    K = torch.Tensor([16]) # rois_per_image
    n_frames = torch.Tensor([22])
    step = 8

    calc = Translate_Calculator(sample_duration,step)
    ret_2 = calc(N,K,n_frames,p_tubes,final_combinations.int().cuda())
    ret = torch.zeros(4,25,4)
    ret[:,:22] = ret_2
    print('ret :',ret)
    print('ret :',ret.shape)
    print('exp_ret :',exp_ret.shape)
    print(ret== exp_ret.type_as(ret))
    print(ret[3])
    print(exp_ret[3])


